<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escáner de Código de Barras</title>
  <link rel="stylesheet" href="style.css" />
  <script src="jquery.js"></script>
  <script src="/scripts/barcode.js"></script>
  <script src="/scripts/scripts.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let latitud = null;
      let longitud = null;

      const sound = new Audio("barcode.wav");

      barcode.config.start = 0.1;
      barcode.config.end = 0.9;
      barcode.config.video = "#barcodevideo";
      barcode.config.canvas = "#barcodecanvas";
      barcode.config.canvasg = "#barcodecanvasg";

      barcode.init();
      console.log("Handler activado");

      barcode.setHandler(async function (codigo) {
        console.log("Código escaneado:", codigo);
        document.getElementById(
          "result"
        ).textContent = `Código detectado: ${codigo}`;
        sound.play();

        const supermercadoSeleccionado = JSON.parse(
          localStorage.getItem("supermercadoSeleccionado")
        );
        if (!supermercadoSeleccionado || !supermercadoSeleccionado.id) {
          alert("Por favor, selecciona un supermercado antes de escanear.");
          return;
        }

        try {
          const response = await fetch(
            `https://scansuper.up.railway.app/api/precios/${codigo}`
          );

          if (response.status === 404) {
            const data = await response.json();
            document.getElementById("result").textContent =
              data.mensaje || "Producto no encontrado.";
            return;
          }

          if (!response.ok) {
            throw new Error(`Error en la solicitud: ${response.status}`);
          }

          const data = await response.json();
          await mostrarInformacionProducto(data);
        } catch (error) {
          console.error("Error al buscar el producto:", error);
          document.getElementById("result").textContent =
            "Producto no encontrado o error en la solicitud.";
        }
      });

      document
        .getElementById("get-location")
        .addEventListener("click", async () => {
          if (!navigator.geolocation) {
            alert("Geolocalización no soportada en este navegador.");
            return;
          }

          navigator.geolocation.getCurrentPosition(
            async (position) => {
              latitud = position.coords.latitude;
              longitud = position.coords.longitude;

              try {
                const response = await fetch(
                  `https://scansuper.up.railway.app/api/precios/supermercados?lat=${latitud}&lng=${longitud}`
                );
                if (!response.ok) {
                  throw new Error(
                    `Error en la solicitud: ${response.status}`
                  );
                }
                const data = await response.json();

                if (data.length === 0) {
                  alert("No se encontraron supermercados cercanos.");
                } else {
                  mostrarSupermercadosCercanos(data);
                }
              } catch (error) {
                console.error("Error al obtener supermercados cercanos:", error);
                alert("No se pudo cargar la lista de supermercados.");
              }
            },
            (error) => {
              console.error("Error al obtener la ubicación:", error);
              alert(
                "No se pudo obtener la ubicación. Por favor, revisa los permisos."
              );
            }
          );
        });



      let carrito = [];
      function agregarAlCarrito(producto, precio) {
        carrito.push({
          nombre: producto.nombre,
          precio: precio.precio,
        });
        actualizarCarrito();
      }


    });
  </script>
</head>
<body>
  <h2>Supermercados Cercanos</h2>
  <button id="get-location">¿Donde estas comprando?</button>
  <div id="geo-info"></div>
  <div id="supermarkets"></div>
  <div id="selected-supermarket">
    <p id="current-supermarket">Supermercado seleccionado: Ninguno</p>
  </div>
  <h1>Escáner de Código de Barras</h1>
  <div id="barcode">
    <video
      id="barcodevideo"
      autoplay
      playsinline
      style="width: 100%; max-width: 600px; border: 2px solid #000"
    ></video>
    <canvas
      id="barcodecanvasg"
      style="position: absolute; top: 0; left: 0"
    ></canvas>
  </div>
  <canvas id="barcodecanvas"></canvas>
  <div id="result">Esperando código...</div>
  <div id="product-info">
    <p>Esperando información del producto...</p>
  </div>
  <div id="carrito">
    <h3>Carrito:</h3>
    <ul></ul>
  </div>
</body>
</html>
